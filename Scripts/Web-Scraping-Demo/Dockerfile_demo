# We’re using the Rocker project’s R-4.4.1 as the base. 
# It's the gold standard for reproducible research in the R community.
FROM rocker/r-ver:4.4.1

# This keeps the build from stalling on interactive "choose your time zone" prompts.
ENV DEBIAN_FRONTEND=noninteractive

# System-level dependencies for R and Chrome. 
# libcurl and libxml2 are essential for rvest, while the rest are needed 
# to keep Chrome stable in a headless (no-GUI) environment.
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget gnupg2 ca-certificates \
    libnss3 libatk-bridge2.0-0 libgtk-3-0 libxss1 libasound2 \
    libcurl4-openssl-dev libssl-dev libxml2-dev \
    && rm -rf /var/lib/apt/lists/*

# Installing Google Chrome. We need the stable version to serve as the 
# engine for 'chromote'—which handles the visual rendering for our scrapers.
RUN wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add - \
    && echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list \
    && apt-get update && apt-get install -y google-chrome-stable \
    && rm -rf /var/lib/apt/lists/*

# Setting up our R toolkit. 
# 'targets' is here for pipeline management, and 'chromote' for the web automation.
RUN R -e "install.packages(c('remotes', 'renv'))"
RUN R -e "remotes::install_cran(c('chromote', 'targets', 'dplyr', 'rvest', 'jsonlite'))"

# Running as root is a security risk in production and research labs.
# We'll create a dedicated 'researcher' user and work from their home directory.
RUN groupadd -r research && useradd -r -g research -d /home/research -m research
WORKDIR /home/research
COPY . .
RUN chown -R research:research /home/research

USER research

# Launching into R. This environment is now fully ready to run the 
# 'targets' pipeline or interactive scraping scripts.
CMD ["R"]
